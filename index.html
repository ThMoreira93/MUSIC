<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Harmonia TH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUAIS (Mantidos da versão Pro) --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card {
            background-color: #1e1e1e;
            border-radius: 16px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .input-field {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }
        .input-field:focus { border-color: #8b5cf6; outline: none; }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .btn-primary:active { transform: scale(0.96); }

        canvas.chord-diagram {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .ripple { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); }
        .tab-active { border-bottom: 2px solid #8b5cf6; color: #8b5cf6; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-900 p-4 shadow-lg flex items-center justify-between z-20 sticky top-0 border-b border-gray-800">
        <div class="flex items-center gap-3">
            <div class="bg-purple-900 p-2 rounded-full">
                <i class="fas fa-guitar text-white text-sm"></i>
            </div>
            <h1 class="text-lg font-bold tracking-wide text-white">Minha Harmonia <span class="text-purple-500">TH</span></h1>
        </div>
    </header>

    <!-- Navegação -->
    <nav class="flex justify-around bg-gray-900 border-b border-gray-800 text-sm font-semibold">
        <button onclick="switchTab('field')" id="tab-field" class="flex-1 p-3 tab-active transition-colors">Campo Harmônico</button>
        <button onclick="switchTab('dict')" id="tab-dict" class="flex-1 p-3 tab-inactive transition-colors">Dicionário</button>
    </nav>

    <!-- Área Principal -->
    <main class="flex-1 overflow-y-auto p-4 space-y-6 hide-scrollbar pb-32 relative">
        
        <!-- VISUALIZAÇÃO DO ACORDE (Topo) -->
        <section id="displayArea" class="card p-4 sticky top-0 z-10 bg-[#1e1e1e] shadow-2xl hidden transition-all border border-purple-900">
            <div class="flex justify-between items-start">
                <div class="flex flex-col justify-between h-[120px]">
                    <div>
                        <h2 id="displayChordName" class="text-4xl font-bold text-white mb-1">C</h2>
                        <p id="displayNotes" class="text-purple-400 text-sm font-mono font-bold mb-2">C - E - G</p>
                    </div>
                    <button onclick="replayLastChord()" class="bg-gray-800 active:bg-gray-700 text-gray-300 px-4 py-2 rounded-full text-xs flex items-center gap-2 w-max border border-gray-600">
                        <i class="fas fa-volume-up text-purple-400"></i> Ouvir Som
                    </button>
                </div>
                <canvas id="chordCanvas" width="100" height="120" class="chord-diagram"></canvas>
            </div>
        </section>

        <!-- TAB 1: CAMPO HARMÔNICO -->
        <div id="view-field" class="space-y-6 animate-fade-in">
            <section class="card p-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Tom & Modo</h2>
                </div>
                <div class="flex gap-3">
                    <select id="keySelect" class="flex-1 p-3 rounded-lg input-field font-bold text-lg text-center appearance-none" onchange="handleConfigChange()"></select>
                    <select id="modeSelect" class="flex-1 p-3 rounded-lg input-field font-bold text-lg text-center appearance-none" onchange="handleConfigChange()">
                        <option value="major">Maior</option>
                        <option value="minor">Menor</option>
                    </select>
                </div>
            </section>

            <section>
                <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2 ml-1">Graus do Campo</h2>
                <div id="harmonicFieldContainer" class="grid grid-cols-4 gap-2"></div>
            </section>

            <section class="card p-4 border-t-2 border-purple-800">
                <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Criar Sequência</label>
                <div class="flex gap-2 mb-3">
                    <input type="tel" id="sequenceInput" placeholder="Ex: 1 4 5 6" class="flex-1 p-3 rounded-lg input-field text-lg tracking-widest placeholder-gray-600" onkeydown="if(event.key === 'Enter') processSequence()">
                    <button onclick="processSequence()" class="btn-primary w-14 rounded-lg flex items-center justify-center text-xl ripple">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <div id="sequenceResultContainer" class="hidden">
                    <div class="h-px bg-gray-700 w-full mb-3"></div>
                    <div id="sequenceCards" class="flex flex-wrap gap-3 justify-center"></div>
                </div>
            </section>
        </div>

        <!-- TAB 2: DICIONÁRIO -->
        <div id="view-dict" class="hidden space-y-6 animate-fade-in">
            <section class="card p-4">
                <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-3">Selecione o Acorde</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Nota</label>
                        <select id="dictRoot" class="w-full p-3 rounded-lg input-field font-bold appearance-none text-center"></select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Tipo</label>
                        <select id="dictType" class="w-full p-3 rounded-lg input-field font-bold appearance-none text-center">
                            <option value="M">Maior</option>
                            <option value="m">Menor</option>
                            <option value="7">7 (Dominante)</option>
                            <option value="m7">m7</option>
                            <option value="maj7">7M</option>
                            <option value="9">9</option>
                            <option value="m9">m9</option>
                            <option value="sus4">sus4</option>
                            <option value="dim">Diminuto</option>
                            <option value="m7b5">m7(b5)</option>
                            <option value="6">6</option>
                            <option value="m6">m6</option>
                        </select>
                    </div>
                </div>
                <button onclick="playDictionaryChord()" class="w-full btn-primary p-4 rounded-lg font-bold ripple mt-2 text-lg shadow-lg">
                    <i class="fas fa-eye mr-2"></i> Visualizar
                </button>
            </section>
        </div>

        <div class="h-12"></div>
    </main>

    <script>
        // --- DADOS TEÓRICOS (NOTAS E INTERVALOS) ---
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SCALE_INTERVALS = { major: [0,2,4,5,7,9,11], minor: [0,2,3,5,7,8,10] };
        const DIATONIC_TYPES = { 
            major: ['M', 'm', 'm', 'M', 'M', 'm', 'dim'],
            minor: ['m', 'dim', 'M', 'm', 'm', 'M', 'M'] 
        };
        const CHORD_FORMULAS = {
            'M': [0, 4, 7], 'm': [0, 3, 7], 'dim': [0, 3, 6],
            '7': [0, 4, 7, 10], 'm7': [0, 3, 7, 10], 'maj7': [0, 4, 7, 11],
            '9': [0, 4, 7, 10, 14], 'm9': [0, 3, 7, 10, 14],
            'sus4': [0, 5, 7], 'm7b5': [0, 3, 6, 10], '6': [0, 4, 7, 9], 'm6': [0, 3, 7, 9]
        };

        // Formatos visuais (Diagramas simplificados)
        const CHORD_SHAPES = {
            'C_M': [0,3,2,0,1,0], 'C_m': [-1,3,5,5,4,3], 'C_7': [0,3,2,3,1,0], 'C_maj7': [0,3,2,0,0,0],
            'D_M': [-1,-1,0,2,3,2], 'D_m': [-1,-1,0,2,3,1], 'D_7': [-1,-1,0,2,1,2], 'D_maj7': [-1,-1,0,2,2,2],
            'E_M': [0,2,2,1,0,0], 'E_m': [0,2,2,0,0,0], 'E_7': [0,2,0,1,0,0], 'E_maj7': [0,2,1,1,0,0],
            'F_M': [1,3,3,2,1,1], 'F_m': [1,3,3,1,1,1], 'F_7': [1,3,1,2,1,1], 'F_maj7': [-1,-1,3,2,1,0],
            'G_M': [3,2,0,0,0,3], 'G_m': [3,5,5,3,3,3], 'G_7': [3,2,0,0,0,1], 'G_maj7': [3,2,0,0,0,2],
            'A_M': [-1,0,2,2,2,0], 'A_m': [-1,0,2,2,1,0], 'A_7': [-1,0,2,0,2,0], 'A_maj7': [-1,0,2,1,2,0],
            'B_M': [-1,2,4,4,4,2], 'B_m': [-1,2,4,4,3,2], 'B_7': [-1,2,1,2,0,2]
        };

        // --- AUDIO ENGINE: CLÁSSICO (VERSÃO 1 - LIMPA) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let lastPlayedFreqs = [];

        function getNoteFreq(index, octave) {
            // Cálculo preciso de frequência
            const baseA4 = 440;
            const semitonesFromA4 = (index - 9) + (octave - 4) * 12;
            return baseA4 * Math.pow(2, semitonesFromA4 / 12);
        }

        function playTone(freq, startTime, duration = 1.5) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            // Onda Triângulo: Som suave, parecido com flauta/órgão, sem distorção
            osc.type = 'triangle'; 
            osc.frequency.value = freq;

            // Envelope de volume simples (evita o "pop" ou estouro)
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.05); // Ataque suave
            gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration); // Decaimento

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        function strumChord(freqs) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            lastPlayedFreqs = freqs;

            const now = audioCtx.currentTime;
            // Strumming: pequeno atraso entre as notas para simular o passar do dedo
            freqs.forEach((freq, i) => {
                if(freq) playTone(freq, now + (i * 0.05)); 
            });
        }

        // --- FUNÇÕES VISUAIS (CANVAS) ---
        function drawDiagram(chordName, shape) {
            const canvas = document.getElementById('chordCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,w,h);
            const mx = 15; const my = 20;
            const sGap = (w - 2*mx)/5; const fGap = (h - 2*my)/5;

            // Desenha braço
            ctx.lineWidth = 1; ctx.strokeStyle = "#333";
            for(let i=0; i<=5; i++){
                let y = my + i*fGap;
                ctx.beginPath(); ctx.moveTo(mx, y); ctx.lineTo(w-mx, y); ctx.stroke();
                if(i===0) { ctx.lineWidth=3; ctx.stroke(); ctx.lineWidth=1; }
            }
            for(let i=0; i<6; i++){
                let x = mx + i*sGap;
                ctx.beginPath(); ctx.moveTo(x, my); ctx.lineTo(x, h-my); ctx.stroke();
            }

            // Desenha dedos
            if(!shape) shape = [-1,-1,-1,-1,-1,-1];
            shape.forEach((fret, str) => {
                let x = mx + str*sGap;
                if(fret === -1) {
                    ctx.font = "12px Arial"; ctx.fillStyle="#333"; ctx.fillText("x", x-3, my-5);
                } else if(fret === 0) {
                    ctx.beginPath(); ctx.strokeStyle="#333"; ctx.arc(x, my-8, 3, 0, 6.28); ctx.stroke();
                } else {
                    let y = my + (fret-0.5)*fGap;
                    ctx.beginPath(); ctx.fillStyle="#000"; ctx.arc(x, y, 6, 0, 6.28); ctx.fill();
                }
            });
        }

        function getShape(root, type) {
            let k = `${root}_${type}`;
            if(CHORD_SHAPES[k]) return CHORD_SHAPES[k];
            // Fallback visual inteligente
            if(type.includes('9') || type.includes('sus')) {
                if(CHORD_SHAPES[`${root}_M`]) return CHORD_SHAPES[`${root}_M`];
            }
            return [-1,-1,-1,-1,-1,-1];
        }

        // --- LÓGICA DO APP ---
        function activateChord(root, type, displayName) {
            const displayArea = document.getElementById('displayArea');
            displayArea.classList.remove('hidden');
            
            document.getElementById('displayChordName').innerText = displayName;
            
            const rIdx = NOTES.indexOf(root);
            const form = CHORD_FORMULAS[type] || CHORD_FORMULAS['M'];
            const notes = form.map(int => NOTES[(rIdx + int) % 12]);
            document.getElementById('displayNotes').innerText = notes.join(' - ');

            const shape = getShape(root, type);
            drawDiagram(displayName, shape);

            // Montagem das Frequências (Voicing Simples)
            let baseOct = 3; 
            let freqs = [];
            // Tônica
            freqs.push(getNoteFreq(rIdx, baseOct)); 
            // Outras notas
            form.forEach((interval, i) => {
                if(i===0) return;
                let oct = baseOct + 1;
                if(interval > 11) oct++; 
                freqs.push(getNoteFreq((rIdx + interval)%12, oct));
            });
            
            strumChord(freqs);
        }

        function replayLastChord() {
            if(lastPlayedFreqs.length) strumChord(lastPlayedFreqs);
        }

        function handleConfigChange() {
            renderHarmonicField();
            if(document.getElementById('sequenceInput').value) processSequence();
        }

        function renderHarmonicField() {
            const root = document.getElementById('keySelect').value;
            const mode = document.getElementById('modeSelect').value;
            const container = document.getElementById('harmonicFieldContainer');
            
            container.innerHTML = '';
            const rIdx = NOTES.indexOf(root);
            const intervals = SCALE_INTERVALS[mode];
            const types = DIATONIC_TYPES[mode];

            intervals.forEach((int, i) => {
                const note = NOTES[(rIdx + int) % 12];
                const type = types[i];
                
                let label = note;
                if(type === 'm') label += 'm';
                if(type === 'dim') label += '°';

                const btn = document.createElement('div');
                btn.className = 'bg-gray-800 rounded-lg h-20 flex flex-col items-center justify-center border border-gray-700 cursor-pointer relative ripple active:border-purple-500 active:bg-gray-700 transition-colors';
                let tColor = type === 'M' ? 'text-blue-400' : (type === 'm' ? 'text-yellow-400' : 'text-red-400');

                btn.innerHTML = `
                    <span class="absolute top-1 left-2 text-[10px] text-gray-500 font-bold">${i+1}°</span>
                    <span class="text-xl font-bold ${tColor}">${label}</span>
                `;
                
                btn.onclick = () => activateChord(note, type, label);
                container.appendChild(btn);
            });
        }

        function processSequence() {
            const input = document.getElementById('sequenceInput').value;
            const container = document.getElementById('sequenceResultContainer');
            const cardsDiv = document.getElementById('sequenceCards');
            const matches = input.match(/[1-7]/g);
            
            cardsDiv.innerHTML = '';
            if(!matches || matches.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            const root = document.getElementById('keySelect').value;
            const mode = document.getElementById('modeSelect').value;
            const rIdx = NOTES.indexOf(root);
            const intervals = SCALE_INTERVALS[mode];
            const types = DIATONIC_TYPES[mode];

            matches.forEach(numStr => {
                const degree = parseInt(numStr) - 1;
                if(degree >= 0 && degree < 7) {
                    const interval = intervals[degree];
                    const note = NOTES[(rIdx + interval) % 12];
                    const type = types[degree];
                    let label = note + (type === 'm' ? 'm' : (type === 'dim' ? '°' : ''));

                    const card = document.createElement('div');
                    card.className = 'bg-purple-900 bg-opacity-40 border border-purple-600 rounded-lg p-3 w-20 flex flex-col items-center cursor-pointer active:bg-purple-800';
                    card.innerHTML = `
                        <span class="text-xs text-gray-400 mb-1">${numStr}°</span>
                        <span class="text-lg font-bold text-white">${label}</span>
                    `;
                    card.onclick = () => activateChord(note, type, label);
                    cardsDiv.appendChild(card);
                }
            });
        }

        function playDictionaryChord() {
            const root = document.getElementById('dictRoot').value;
            const type = document.getElementById('dictType').value;
            let label = root + type;
            if(type === 'M') label = root;
            if(type === 'maj7') label = root + '7M';
            activateChord(root, type, label);
        }

        function init() {
            const selK = document.getElementById('keySelect');
            const selD = document.getElementById('dictRoot');
            NOTES.forEach(n => {
                selK.add(new Option(n, n));
                selD.add(new Option(n, n));
            });
            handleConfigChange();
        }

        function switchTab(t) {
            document.getElementById('view-field').classList.add('hidden');
            document.getElementById('view-dict').classList.add('hidden');
            document.getElementById('tab-field').className = 'flex-1 p-3 tab-inactive';
            document.getElementById('tab-dict').className = 'flex-1 p-3 tab-inactive';
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).className = 'flex-1 p-3 tab-active';
        }

        init();
    </script>
</body>
</html>


